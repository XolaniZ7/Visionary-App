---
import AdPlacement from "@components/AdPlacement.astro";
import BookComponent from "@components/Book.astro";
import { titleCase } from "@components/BookSection.astro";
import Pagination from "@components/Pagination.astro";
import TipModal from "@components/TipModal";
import SiteLayout from "@layouts/SiteLayout.astro";
import crypto from "crypto";
import { sql } from "kysely";
import { stripHtml } from "string-strip-html";
import { z } from "zod";

import { getUser } from "@server/astroHelpers";
import { getAuthor, k, p } from "@server/db";

const { id } = Astro.params;
console.log({ ss: Astro.clientAddress });
const authorId = z.coerce.number().parse(id);
const author = await getAuthor(authorId);

const pageParam = Astro.url.searchParams.get("page");
const pageN = z.coerce.number().parse(pageParam);
const page = pageN || 1; // set a default page number
const pageSize = 8; // set a default page size
const offset = (page - 1) * pageSize;

const authorBooks = await k
  .selectFrom("book")
  .where("user_id", "=", authorId)
  .where("status", "=", "1")
  .where("deleted_at", "is", null)
  .select(["id", "book_cover", "title", "complete", "slug", "book_order", "genre", "description"])
  .orderBy("book_order", "asc")
  .offset(offset)
  .limit(pageSize)
  .execute();

const authorBooksTotal = await k
  .selectFrom("book")
  .where("user_id", "=", authorId)
  .where("status", "=", "1")
  .where("deleted_at", "is", null)
  .select(k.fn.count<number>("book.id").as("count"))
  .executeTakeFirst();

const user = await getUser(Astro.request);

if (!Astro.cookies.has("astroSessionId")) {
  console.log("adding cookie");
  const newSession = crypto.randomUUID();
  Astro.cookies.set("astroSessionId", newSession);
  Astro.response.headers.append("astroSessionId", newSession);
}

const sessionId = Astro.cookies.get("astroSessionId");

if (user) {
  const chkuser = await k
    .selectFrom("authors_view_count")
    .select((eb) => eb.fn.count<number>("id").as("count"))
    .where("user_id", "=", authorId)
    .where("logged_in_user_id", "=", user.id)
    .executeTakeFirstOrThrow();

  if (chkuser.count === 0) {
    await p.authors_view_count.create({
      data: {
        session_id: sessionId.value,
        user_id: authorId,
        logged_in_user_id: user.id,
      },
    });
    await p.users.update({ where: { id: authorId }, data: { views: { increment: 1 } } });

    const { authorViewCount } = await k
      .selectFrom("authors_view_count")
      .select((eb) => eb.fn.count<number>("id").as("authorViewCount"))
      .where("user_id", "=", authorId)
      .executeTakeFirstOrThrow();

    const amount = 0.0000;
    const type = "profile";

    await p.transaction.create({
      data: {
        user_id: authorId,
        amount: amount,
        type: type,
        on_views: authorViewCount,
        date: new Date(),
      },
    });
    await p.users.update({ where: { id: authorId }, data: { amount: { increment: amount } } });
    await p.users.updateMany({ where: { admin: true }, data: { amount: { increment: amount } } });
  }
} else {
  const { sessionViewCount } = await k
    .selectFrom("authors_view_count")
    .select((eb) => eb.fn.count<number>("id").as("sessionViewCount"))
    .where("session_id", "=", sessionId.value ?? "")
    .where("user_id", "=", authorId)
    .executeTakeFirstOrThrow();
  if (sessionViewCount == 0) {
    await p.authors_view_count.create({
      data: {
        session_id: sessionId.value,
        user_id: authorId,
      },
    });
    await p.users.update({ where: { id: authorId }, data: { views: { increment: 1 } } });

    const { authorViewCount } = await k
      .selectFrom("authors_view_count")
      .select((eb) => eb.fn.count<number>("id").as("authorViewCount"))
      .where("user_id", "=", authorId)
      .executeTakeFirstOrThrow();

    const amount = 0.0000;
    const type = "profile";

    await p.transaction.create({
      data: {
        user_id: authorId,
        amount: amount,
        type: type,
        on_views: authorViewCount,
        date: new Date(),
      },
    });
    await p.users.update({ where: { id: authorId }, data: { amount: { increment: amount } } });
    await p.users.updateMany({ where: { admin: true }, data: { amount: { increment: amount } } });
  }
}
---

<SiteLayout title={`Author - ${author.name}`}>
  <div class="p-8 2xl:px-52 2xl:py-16 min-h-full">
    <AdPlacement page="Books" type="Top" pageContent={[author.about ?? ""]} />
    <div class="grid md:grid-cols-2 2xl:grid-cols-4 gap-12">
      <div class="card md:col-span-2 2xl:col-span-1 h-fit w-full bg-accent text-primary-content">
        <div class="card-body">
          <div class="avatar">
            <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
              <img
                onerror={`this.onerror=null; this.src='/kq6bujqw.bmp'`}
                src={`https://imagedelivery.net/sdqQx4FWOKQ_S_S-shOoYw/avatars/${author.avatar}/Thumbnail`}
              />
            </div>
          </div>
          <h2 class="card-title font-ebgaramond text-2xl mt-2">{author.name}</h2>
          <div>
            <div set:html={author.about} />
          </div>

          {
            author.verified > 0 && author.active > 0 && (
              <TipModal user={user} author={author} client:idle />
            )
          }
        </div>
      </div>
      <div class="md:col-span-2 2xl:col-span-3">
        <h3 class="font-ebgaramond text-4xl">Books by {author.name}</h3>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 pt-6">
          {
            authorBooks.map((book) => (
              <>
                <div class="card bg-base-300 card-compact w-full  shadow-xl">
                  <img
                    onerror={`this.onerror=null; this.src='/api/fallback/${book.id}'`}
                    data-theme="dark "
                    class="bg-black w-full text-xl text-center aspect-book object-cover rounded-t-2xl"
                    src={`https://imagedelivery.net/sdqQx4FWOKQ_S_S-shOoYw/uploads/${book.book_cover}/public`}
                    alt={book.title}
                  />

                  <div class="card-body justify-between items-center md:items-start">
                    <div>
                      <h2 class="card-title font-poppins text-lg">{book.title}</h2>
                      <p class="hidden md:inline">
                        {stripHtml(book.description ?? "")
                          .result.split(" ")
                          .slice(0, 30)
                          .join(" ")}
                      </p>

                      <p class="md:hidden">
                        {stripHtml(book.description ?? "")
                          .result.split(" ")
                          .slice(0, 15)
                          .join(" ")}
                      </p>
                    </div>
                    <a href={"/book/" + book.id} class="btn btn-primary mt-2 w-full">
                      View Book
                    </a>
                  </div>
                </div>
              </>
            ))
          }
        </div>
        <div class="flex justify-center my-5">
          {
            authorBooksTotal?.count !== undefined && authorBooksTotal.count > pageSize && (
              <Pagination
                currentPage={page}
                pageSize={pageSize}
                siblingCount={0}
                totalCount={authorBooksTotal.count}
              />
            )
          }
        </div>
      </div>
    </div>
    <AdPlacement page="Books" type="Bottom" pageContent={[author.about ?? ""]} />
  </div>
</SiteLayout>
