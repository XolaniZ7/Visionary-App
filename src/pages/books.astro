---
import AdPlacement from "@components/AdPlacement.astro";
import BookSearch from "@components/BookSearchPage";
import Pagination from "@components/Pagination.astro";
import SiteLayout from "@layouts/SiteLayout.astro";
import { stripHtml } from "string-strip-html";
import { z } from "zod";

import { getUser } from "@server/astroHelpers";
import { getAllBooks, k, p } from "@server/db";
import { booksFuse } from "@server/search";

const { searchTerm } = Astro.params;
const search = Astro.url.searchParams.get("searchTerm")! || "";
const results = booksFuse.search(search, { limit: 20 });

const pageParam = Astro.url.searchParams.get("page");
const pageN = z.coerce.number().parse(pageParam);
const page = pageN || 1; // set a default page number
const pageSize = 20; // set a default page size
const offset = (page - 1) * pageSize;

const allBooksResult = await getAllBooks(offset, pageSize);
const allBooks = allBooksResult.books;
---

<SiteLayout title="Browse">
  <h1 class="text-center text-3xl font-poppins">Browse Books</h1>
  <div class="flex justify-center p-5 min-h-[60vh]">
    <div class="container max-w-4xl">
      <AdPlacement page="Books" type="Top" />
      <!-- <form class="items-center hidden md:flex">
        <label for="simple-search" class="sr-only">Search</label>
        <div class="relative w-full">
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"></div>
          <div class="input-group">
            <input
              value={search}
              name="searchTerm"
              type="text"
              placeholder="Search for Books, Authors or Genres"
              class="input bg-base-300 w-full"
            />
            <button class="btn btn-primary">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg
              >
            </button>
          </div>
        </div>
      </form> -->
      {
        allBooks ? (
          <section class="grid md:grid-cols-2 gap-2 my-3">
            {allBooks.map((result, index) => (
              <>
                <div class="bg-base-300 w-full shadow-md grid grid-cols-3 gap-3 p-4 rounded-lg justify-center items-center">
                  <img
                    onerror={`this.onerror=null; this.src='/api/fallback/${result.id}'`}
                    data-theme="dark "
                    class="bg-black w-full duration-150 hover:scale-105 text-xl text-center aspect-book"
                    src={`https://imagedelivery.net/sdqQx4FWOKQ_S_S-shOoYw/uploads/${result.cover}/public`}
                    alt={result.title}
                  />

                  <div class="col-span-2 flex flex-col justify-between h-full">
                    <div>
                      <h2 class="font-poppins font-bold">{result.title}</h2>
                      <a href={"/author/" + result.userId} class="font-poppins text-sm link">
                        {result.userName}
                      </a>
                      <p class="text-sm mt-2">
                        {stripHtml(result.description ?? "")
                          .result.split(" ")
                          .slice(0, 10)
                          .join(" ")}
                      </p>
                    </div>
                    <a href={"/book/" + result.id} class="btn btn-outline mt-2">
                      View Book
                    </a>
                  </div>
                </div>
                {(index + 1) % 2 === 0 && index > 0 && (
                  <div class="col-span-1 md:col-span-2">
                    <AdPlacement
                      page="Books"
                      type="afterTwoBooks"
                      adIndex={Math.floor(index / 2)}
                    />
                  </div>
                )}
              </>
            ))}
          </section>
        ) : null
      }
      <AdPlacement page="Books" type="Bottom" />
    </div>
  </div>
  <div class="flex justify-center mb-5">
    <Pagination
      currentPage={page}
      pageSize={pageSize}
      siblingCount={0}
      totalCount={allBooksResult.count ?? 0}
    />
  </div>
</SiteLayout>
