---
import crypto from "crypto";

import { getUser } from "@server/astroHelpers";
import { hasValidSubscription } from "@server/db";

interface Props {
  title: string;
  noAds?: boolean;
}

let themeMode = "light";
if (Astro.cookies.has("themeMode")) {
  const themeModeCookie = Astro.cookies.get("themeMode");
  if (themeModeCookie?.value) {
    themeMode = themeModeCookie.value;
  }
}

// TODO: Fix ResponseSentError - cookie setting fails because response headers already sent.
// Need to move this to page component or use middleware to set counter cookie before layout renders.
// Astro.cookies.set("counter", themeMode);

const { title, noAds = false } = Astro.props;
const user2 = await getUser(Astro.request);
const isPro = user2 ? await hasValidSubscription(user2.id) : false;
const showFuse = (process.env.SHOW_FUSE ?? "") === "true" && noAds == false;


---

<!DOCTYPE html>
<html data-theme={themeMode} lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"
      rel="stylesheet"
    />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <script src="https://cdn.jsdelivr.net/npm/theme-change@2.0.2/index.js"></script>

    {
      !isPro && showFuse && (
        <script async src="https://cdn.fuseplatform.net/publift/tags/2/2663/fuse.js" />
      )
    }
    <script
      is:inline
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/Glide.js/3.2.0/glide.min.js"
      integrity="sha512-IkLiryZhI6G4pnA3bBZzYCT9Ewk87U4DGEOz+TnRD3MrKqaUitt+ssHgn2X/sxoM7FxCP/ROUp6wcxjH/GcI5Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script async is:inline src="https://www.googletagmanager.com/gtag/js?id=UA-76356300-1"
    ></script>
    <script lang="js">
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "UA-76356300-1");
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XC2RDB1MV3"></script>
    <script lang="js">
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-XC2RDB1MV3");
    </script>

    <script is:inline async defer src={`https://www.google.com/recaptcha/api.js`}></script>

    <title>Visionary Writings - {title}</title>
  </head>
  <body>
    <slot />
  </body>
</html>
